<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title data-react-helmet="true">Relay&#x27;s new applyUpdate function</title><meta data-react-helmet="true" name="description" content="How to use Relay&#x27;s applyUpdate function and retry a failed transaction"/><link href="https://fonts.googleapis.com/css?family=Raleway:300,400,700" rel="stylesheet"/><link rel="author" href="https://plus.google.com/103412889445491341044"/><script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB10DGDrJaB7IauMg99tM97DUH9QC4rcO8"></script><style>.me{border-bottom:1px solid #eee;text-align:center;margin-bottom:40px}.me__profile{padding:10px}.me__profile__name{font-weight:700;color:#222;margin-top:10px;margin-bottom:0}.me__profile__desc{font-size:20px;font-weight:200;color:#aaa;margin-top:20px}.me__photo{animation:bounce 1s normal;margin-right:20px}.me__photo img{margin:0}.me__photo img:hover{animation:bounce 1s infinite}.me__photo__avatar{display:inline-block;width:110px;height:110px;border-radius:50%}.me__separator{width:60%;border-top:1px solid #eee}.me p a{font-weight:500}.me p{color:#aaa;font-weight:200;margin:0;padding:5px}.me p:last-child{margin-bottom:15px}@keyframes bounce{0%,20%,53%,80%,to{animation-timing-function:cubic-bezier(.215,.61,.355,1);transform:translateZ(0)}40%,43%{animation-timing-function:cubic-bezier(.755,.05,.855,.06);transform:translate3d(0,-30px,0)}70%{animation-timing-function:cubic-bezier(.755,.05,.855,.06);transform:translate3d(0,-15px,0)}90%{transform:translate3d(0,-4px,0)}}.markdown img{width:100%}.markdown p,li,ul{color:#666;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;font-size:18px;line-height:1.4em;margin-top:20px;margin-bottom:20px}.markdown pre{display:block;background:#3f3f3f;color:#dcdcdc;overflow-y:hidden;margin-top:30px;margin-bottom:30px}.markdown pre code{background:none;border:none;border-radius:3px;display:inline-block;overflow:inherit;padding:1.58333rem;white-space:inherit;word-wrap:normal}code{border-radius:3px;white-space:pre;white-space:pre-wrap;white-space:pre-line;white-space:-pre-wrap;white-space:-o-pre-wrap;white-space:-moz-pre-wrap;white-space:-hp-pre-wrap;word-wrap:break-word;background:#e5e5e5;border:1px solid #ccc;display:inline;font-family:Inconsolata,monospace,serif;max-width:100%;overflow:auto;padding:0 .1625rem}.clojure .hljs-attribute,.css .hljs-class,.css .hljs-id,.hljs-keyword,.hljs-request,.hljs-status,.hljs-tag,.lisp .hljs-title,.nginx .hljs-title{color:#e3ceab}.django .hljs-filter .hljs-argument,.django .hljs-template_tag,.django .hljs-variable{color:#dcdcdc}.hljs-date,.hljs-number{color:#8cd0d3}.apache .hljs-sqbracket,.dos .hljs-envvar,.dos .hljs-stream,.hljs-variable{color:#efdcbc}.diff .hljs-change,.dos .hljs-flow,.hljs-literal,.python .exception,.python .hljs-built_in,.tex .hljs-special{color:#efefaf}.diff .hljs-chunk,.hljs-subst{color:#8f8f8f}.apache .hljs-tag,.diff .hljs-header,.dos .hljs-keyword,.haskell .hljs-type,.hljs-prompt,.hljs-title,.nginx .hljs-built_in,.python .hljs-decorator,.ruby .hljs-class .hljs-parent,.tex .hljs-command{color:#efef8f}.dos .hljs-winutils,.ruby .hljs-string,.ruby .hljs-symbol,.ruby .hljs-symbol .hljs-string{color:#dca3a3}.apache .hljs-cbracket,.coffeescript .hljs-attribute,.css .hljs-rules .hljs-value,.diff .hljs-deletion,.hljs-attr_selector,.hljs-built_in,.hljs-javadoc,.hljs-pragma,.hljs-preprocessor,.hljs-pseudo,.hljs-string,.hljs-tag .hljs-value,.smalltalk .hljs-array,.smalltalk .hljs-class,.smalltalk .hljs-localvars,.sql .hljs-aggregate,.tex .hljs-formula{color:#cc9393}.diff .hljs-addition,.hljs-comment,.hljs-doctype,.hljs-pi,.hljs-shebang,.hljs-template_comment,.java .hljs-annotation{color:#7f9f7f}.coffeescript .javascript,.javascript .xml,.tex .hljs-formula,.xml .css,.xml .hljs-cdata,.xml .javascript,.xml .vbscript{opacity:.5}.post__title{text-align:center;font-weight:200;color:#222;margin-top:0}p.post__date{font-size:14px;text-transform:uppercase;color:#aaa;text-align:center;margin:0 auto;margin-bottom:40px}body{margin:0;border-top:8px solid #d64292;font-family:Raleway,sans-serif}.wrapper{padding:60px 40px 0;max-width:700px;margin:0 auto}.love{font-weight:200}.load-more,.love{padding-bottom:80px;padding-top:60px;color:#aaa;text-align:center;margin:0 auto}.load-more{font-size:16px;font-weight:500}.load-more button{font-size:16px;font-weight:700;color:#d64292;background:none;border:none;margin:0;padding:0;cursor:pointer}.load-more button:hover{text-decoration:underline}.purple,a{color:#d64292;text-decoration:none}hr{margin-top:40px;margin-bottom:40px;width:80%;border:1px solid #eee}.post-list{padding:10px}.post-list__item{text-decoration:none;display:block;padding-left:20px;border-left:4px solid #aaa;min-height:100px;margin-bottom:80px;transition:all .4s ease-out}.post-list__item-enter{opacity:.01}.post-list__item-enter-active{opacity:1}.post-list__item:last-child{margin-bottom:0}.post-list__item:hover{border-left:4px solid #d64292}.post-list__item__header{margin-top:26px;display:-ms-flexbox;display:flex}.post-list__item__header__title{-ms-flex:4;flex:4;font-size:20px;color:#222;margin-top:0;margin-bottom:8px}.post-list__item__header__date{-ms-flex:1;flex:1;color:#aaa;text-align:right}.post-list__item__desc{color:#aaa;font-size:18px;margin-top:0}.talk-list{max-width:600px;margin:0 auto}.talk-list__talk{border-radius:2px;margin-top:40px;display:-ms-flexbox;display:flex;box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);transition:all .3s cubic-bezier(.25,.8,.25,1)}.talk-list__talk:hover{box-shadow:0 14px 28px rgba(0,0,0,.25),0 10px 10px rgba(0,0,0,.22)}.talk-list__talk__map{-ms-flex:1;flex:1}.talk-list__talk__content{padding:20px;-ms-flex:3;flex:3}.talk-list__talk__content p{margin-top:0;margin-bottom:15px}.talk-list__talk__content__name{font-weight:200;font-size:24px}.talk-list__talk__content__name--cancelled{text-decoration:line-through}.cancelled{font-weight:200;font-size:24px;color:red;text-decoration:none}.talk-list__talk__content__event{font-weight:200;color:#222;font-size:18px}.light{color:#aaa}</style></head><body class="landing-page"><div id="react-mount"><div style="max-width:960px;margin-left:auto;margin-right:auto;" data-reactroot="" data-reactid="1" data-react-checksum="1933108608"><div class="wrapper markdown" data-reactid="2"><!-- react-empty: 3 --><h1 class="post__title" data-reactid="4">Relay&#x27;s new applyUpdate function</h1><p class="post__date" data-reactid="5">January 10, 2016</p><div data-reactid="6"><p>I recently contributed to Relay and helped implementing a new function on the Relay Store,
<code>applyUpdate</code>. It was recently merged into master and the standard <code>update</code> method was deprecated in <code>v0.6.1</code>.</p>
<p>Before this, we were limited to <code>RelayStore.update</code> when wanting to use Mutations. For those who are less familiar with how relay mutations work under the cover, Relay has an internal queue to handle mutations. When using <code>RelayStore.update</code>, we were essentially creating a mutation transaction in the queue and committing it instantly.</p>
<p>This actually worked well in most cases, but for more advanced use cases like for debouncing quick mutations on a single field, we needed something else. This is where <code>RelayStore.applyUpdate</code> gets useful. The <code>applyUpdate</code> function adds a mutation just like <code>update</code>, but does not commit it. It returns a <code>RelayMutationTransaction</code> that can be committed, recommitted or rollbacked at a later time.</p>
<h1>Example use case</h1>
<p>I’ve recently seen somebody ask this question on StackOverFlow: We want to enable
retrying a failed mutation. Lets take an example from <a href="https://facebook.github.io/relay/docs/api-reference-relay-container.html#getpendingtransactions">Relay’s docs</a> to do this.</p>
<p>So we want to post a Story, but if it fails, we want to display a link to retry posting
the same story. To do this using <code>applyUpdate</code>, we could keep for example the transaction
in our Component state. When we try the mutation, we create it with applyUpdate, store it,
and try to commit it after.</p>
<p>We now have a reference to this transaction, if we see that the transaction has
a status of COMMIT_FAILED during render, we can actually show the the link to retry,
and call <code>transaction.recommit</code> to try again. Using only <code>update</code> we would lose our
reference to the transaction and doing more things with the transaction after becomes
much more complicated. Here’s what your component could look like:</p>
<pre><code class="language-javascript"><span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Story</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
  <span class="hljs-keyword">constructor</span>(props) {
    <span class="hljs-keyword">super</span>(props);
    <span class="hljs-keyword">this</span>.state = {
      <span class="hljs-attr">transaction</span>: <span class="hljs-literal">null</span>
    };
  }

  postStory(transaction) {
    <span class="hljs-keyword">const</span> onSuccess = <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> {
      <span class="hljs-built_in">console</span>.log(<span class="hljs-string">'Mutation successful!'</span>);
    };

    <span class="hljs-keyword">const</span> onFailure = <span class="hljs-function">(<span class="hljs-params">transaction</span>) =&gt;</span> {
      <span class="hljs-keyword">const</span> error = transaction.getError()
      <span class="hljs-built_in">console</span>.error(error);
    };

    <span class="hljs-keyword">const</span> mutation = <span class="hljs-keyword">new</span> MyMutation({...});
    <span class="hljs-keyword">let</span> transaction = Relay.Store.applyUpdate(
      mutation, { onFailure, onSuccess}
    );

    <span class="hljs-keyword">this</span>.setState({<span class="hljs-attr">transaction</span>: transaction});
    transaction.commit();
  }

  retryPostStory() {
    <span class="hljs-keyword">let</span> transaction = <span class="hljs-keyword">this</span>.state.transaction;
    transaction.recommit;
  }

  render() {
    <span class="hljs-keyword">var</span> story = <span class="hljs-keyword">this</span>.props.story;
    <span class="hljs-keyword">let</span> transaction = <span class="hljs-keyword">this</span>.state.transaction;

    <span class="hljs-keyword">if</span> (transaction) {
      <span class="hljs-keyword">if</span> (transaction.getStatus() === <span class="hljs-string">'COMMIT_FAILED'</span>) {
        <span class="hljs-keyword">return</span> (
          <span class="xml"><span class="hljs-tag">&lt;<span class="hljs-name">span</span>&gt;</span>
            This story failed to post.
            <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">onClick</span>=<span class="hljs-string">{this.retryPostStory.bind(this)}</span>&gt;</span>
              Try Again.
            <span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>
          <span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span></span>
        );
      }
    }
    <span class="hljs-comment">// Render story normally.</span>
  }
}

<span class="hljs-built_in">module</span>.exports = Relay.createContainer(Story, {
  <span class="hljs-attr">fragments</span>: {
    <span class="hljs-attr">story</span>: <span class="hljs-function"><span class="hljs-params">()</span> =&gt;</span> Relay.QL<span class="hljs-string">`
      fragment on story {
        # ...
      }
    `</span>,
  },
});
</code></pre>
<p>I have seen a lot of questions on using Relay that could be solved using apply_update really easily.
Also keep in mind that <code>update</code> is now deprecated and you should use <code>RelayStore#commitUpdate</code> to get the same behavior!</p>
<p>You can find me on Twitter <a href="https://twitter.com/__xuorig__">@__xuorig__</a> or <a href="http://github.com/xuorig">Github</a></p>
</div><p style="text-align:center;font-weight:bold;margin-top:30px;" data-reactid="7"><!-- react-text: 8 -->Go back to <!-- /react-text --><a href="/" data-reactid="9">Recent Posts</a><!-- react-text: 10 --> ✍️<!-- /react-text --></p><hr data-reactid="11"/><div style="margin-bottom:30px;" data-reactid="12"><h6 data-reactid="13">READ THIS NEXT:</h6><h3 data-reactid="14"><a href="/2016/implementing-the-relay-spec-for-a-graphql-server/" data-reactid="15">Implementing the Relay spec in a GraphQL server</a></h3><p data-reactid="16">





I’ve seen some confusion on Relay and GraphQL lately. GraphQL is so often used with Relay that I think sometimes we forget what a GraphQL server is, and what Relay adds on top of it. The goal of...</p></div><section class="disqus" data-reactid="17"><div id="disqus_thread" data-reactid="18"></div><script type="text/javascript" data-reactid="19"></script></section></div><span style="display:block;clear:both;" data-reactid="20"> </span></div></div><script src="/bundle.js?t=1478107512649"></script></body></html>