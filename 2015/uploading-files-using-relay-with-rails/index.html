<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title data-react-helmet="true">Uploading files using Relay and a Rails GraphQL server</title><meta data-react-helmet="true" name="description" content="How to upload a file using GraphQL-ruby&#x27;s context and Relay&#x27;s getFiles"/><link href="https://fonts.googleapis.com/css?family=Raleway:300,400,700" rel="stylesheet"/><link rel="author" href="https://plus.google.com/103412889445491341044"/><script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyB10DGDrJaB7IauMg99tM97DUH9QC4rcO8"></script><style>.me{border-bottom:1px solid #eee;text-align:center;margin-bottom:40px}.me__profile{padding:10px}.me__profile__name{font-weight:700;color:#222;margin-top:10px;margin-bottom:0}.me__profile__desc{font-size:20px;font-weight:200;color:#aaa;margin-top:20px}.me__photo{-webkit-animation:bounce 1s normal;animation:bounce 1s normal;margin-right:20px}.me__photo img{margin:0}.me__photo img:hover{-webkit-animation:bounce 1s infinite;animation:bounce 1s infinite}.me__photo__avatar{display:inline-block;width:110px;height:110px;border-radius:50%}.me__separator{width:60%;border-top:1px solid #eee}.me p a{font-weight:500}.me p{color:#aaa;font-weight:200;margin:0;padding:5px}.me p:last-child{margin-bottom:15px}@-webkit-keyframes bounce{0%,20%,53%,80%,to{-webkit-animation-timing-function:cubic-bezier(.215,.61,.355,1);animation-timing-function:cubic-bezier(.215,.61,.355,1);-webkit-transform:translateZ(0);transform:translateZ(0)}40%,43%{-webkit-animation-timing-function:cubic-bezier(.755,.05,.855,.06);animation-timing-function:cubic-bezier(.755,.05,.855,.06);-webkit-transform:translate3d(0,-30px,0);transform:translate3d(0,-30px,0)}70%{-webkit-animation-timing-function:cubic-bezier(.755,.05,.855,.06);animation-timing-function:cubic-bezier(.755,.05,.855,.06);-webkit-transform:translate3d(0,-15px,0);transform:translate3d(0,-15px,0)}90%{-webkit-transform:translate3d(0,-4px,0);transform:translate3d(0,-4px,0)}}@keyframes bounce{0%,20%,53%,80%,to{-webkit-animation-timing-function:cubic-bezier(.215,.61,.355,1);animation-timing-function:cubic-bezier(.215,.61,.355,1);-webkit-transform:translateZ(0);transform:translateZ(0)}40%,43%{-webkit-animation-timing-function:cubic-bezier(.755,.05,.855,.06);animation-timing-function:cubic-bezier(.755,.05,.855,.06);-webkit-transform:translate3d(0,-30px,0);transform:translate3d(0,-30px,0)}70%{-webkit-animation-timing-function:cubic-bezier(.755,.05,.855,.06);animation-timing-function:cubic-bezier(.755,.05,.855,.06);-webkit-transform:translate3d(0,-15px,0);transform:translate3d(0,-15px,0)}90%{-webkit-transform:translate3d(0,-4px,0);transform:translate3d(0,-4px,0)}}.markdown img{width:100%}.markdown h2{margin-top:30px;margin-bottom:30px}.markdown p,li,ul{color:#666;-webkit-font-smoothing:antialiased;text-rendering:optimizeLegibility;font-size:18px;line-height:1.4em;margin-top:20px;margin-bottom:20px}.markdown pre{display:block;background:#3f3f3f;color:#dcdcdc;overflow-y:hidden;margin-top:30px;margin-bottom:30px}.markdown pre code{background:none;border:none;border-radius:3px;display:inline-block;overflow:inherit;padding:25.333px;padding:1.58333rem;white-space:inherit;word-wrap:normal}code{white-space:pre;white-space:pre-wrap;white-space:pre-line;white-space:-pre-wrap;white-space:-o-pre-wrap;white-space:-moz-pre-wrap;white-space:-hp-pre-wrap;word-wrap:break-word;font-size:85%;background-color:rgba(0,0,0,.04);border-radius:3px;display:inline;font-family:Inconsolata,monospace,serif;max-width:100%;overflow:auto;padding:0 2.6px;padding:0 .1625rem}.clojure .hljs-attribute,.css .hljs-class,.css .hljs-id,.hljs-keyword,.hljs-request,.hljs-status,.hljs-tag,.lisp .hljs-title,.nginx .hljs-title{color:#e3ceab}.django .hljs-filter .hljs-argument,.django .hljs-template_tag,.django .hljs-variable{color:#dcdcdc}.hljs-date,.hljs-number{color:#8cd0d3}.apache .hljs-sqbracket,.dos .hljs-envvar,.dos .hljs-stream,.hljs-variable{color:#efdcbc}.diff .hljs-change,.dos .hljs-flow,.hljs-literal,.python .exception,.python .hljs-built_in,.tex .hljs-special{color:#efefaf}.diff .hljs-chunk,.hljs-subst{color:#8f8f8f}.apache .hljs-tag,.diff .hljs-header,.dos .hljs-keyword,.haskell .hljs-type,.hljs-prompt,.hljs-title,.nginx .hljs-built_in,.python .hljs-decorator,.ruby .hljs-class .hljs-parent,.tex .hljs-command{color:#efef8f}.dos .hljs-winutils,.ruby .hljs-string,.ruby .hljs-symbol,.ruby .hljs-symbol .hljs-string{color:#dca3a3}.apache .hljs-cbracket,.coffeescript .hljs-attribute,.css .hljs-rules .hljs-value,.diff .hljs-deletion,.hljs-attr_selector,.hljs-built_in,.hljs-javadoc,.hljs-pragma,.hljs-preprocessor,.hljs-pseudo,.hljs-string,.hljs-tag .hljs-value,.smalltalk .hljs-array,.smalltalk .hljs-class,.smalltalk .hljs-localvars,.sql .hljs-aggregate,.tex .hljs-formula{color:#cc9393}.diff .hljs-addition,.hljs-comment,.hljs-doctype,.hljs-pi,.hljs-shebang,.hljs-template_comment,.java .hljs-annotation{color:#7f9f7f}.coffeescript .javascript,.javascript .xml,.tex .hljs-formula,.xml .css,.xml .hljs-cdata,.xml .javascript,.xml .vbscript{opacity:.5}p.post__author{font-size:14px;text-align:center;margin:0 auto;margin-bottom:40px;margin-top:20px;color:#aaa}.post__title{text-align:center;font-weight:200;color:#222;margin-top:0}p.post__date{font-size:14px;text-transform:uppercase;color:#aaa;text-align:center;margin:0 auto}body{margin:0;border-top:8px solid #d64292;font-family:Raleway,sans-serif}.wrapper{padding:60px 40px 0;max-width:700px;margin:0 auto}.love{font-weight:200}.load-more,.love{padding-bottom:80px;padding-top:60px;color:#aaa;text-align:center;margin:0 auto}.load-more{font-size:16px;font-weight:500}.load-more button{font-size:16px;font-weight:700;color:#d64292;background:none;border:none;margin:0;padding:0;cursor:pointer}.load-more button:hover{text-decoration:underline}.purple,a{color:#d64292;text-decoration:none}hr{margin-top:40px;margin-bottom:40px;width:80%;border:1px solid #eee}.post-list{padding:10px}.post-list__item{text-decoration:none;display:block;padding-left:20px;border-left:4px solid #aaa;min-height:100px;margin-bottom:80px;transition:all .4s ease-out}.post-list__item-enter{opacity:.01}.post-list__item-enter-active{opacity:1}.post-list__item:last-child{margin-bottom:0}.post-list__item:hover{border-left:4px solid #d64292}.post-list__item__header{margin-top:26px;display:-webkit-box;display:-ms-flexbox;display:flex}.post-list__item__header__title{-webkit-box-flex:4;-ms-flex:4;flex:4;font-size:20px;color:#222;margin-top:0;margin-bottom:8px}.post-list__item__header__date{-webkit-box-flex:1;-ms-flex:1;flex:1;color:#aaa;text-align:right}.post-list__item__desc{color:#aaa;font-size:18px;margin-top:0}.talk-list{max-width:600px;margin:0 auto}.talk-list__talk{border-radius:2px;margin-top:40px;display:-webkit-box;display:-ms-flexbox;display:flex;box-shadow:0 1px 3px rgba(0,0,0,.12),0 1px 2px rgba(0,0,0,.24);transition:all .3s cubic-bezier(.25,.8,.25,1)}.talk-list__talk:hover{box-shadow:0 14px 28px rgba(0,0,0,.25),0 10px 10px rgba(0,0,0,.22)}.talk-list__talk__map{-webkit-box-flex:1;-ms-flex:1;flex:1}.talk-list__talk__content{padding:20px;-webkit-box-flex:3;-ms-flex:3;flex:3}.talk-list__talk__content p{margin-top:0;margin-bottom:15px}.talk-list__talk__content__name{font-weight:200;font-size:24px}.talk-list__talk__content__name--cancelled{text-decoration:line-through}.cancelled{font-weight:200;font-size:24px;color:red;text-decoration:none}.talk-list__talk__content__event{font-weight:200;color:#222;font-size:18px}.light{color:#aaa}</style></head><body class="landing-page"><div id="react-mount"><div style="max-width:960px;margin-left:auto;margin-right:auto;" data-reactroot="" data-reactid="1" data-react-checksum="-539836987"><div class="wrapper markdown" data-reactid="2"><!-- react-empty: 3 --><h1 class="post__title" data-reactid="4">Uploading files using Relay and a Rails GraphQL server</h1><p class="post__date" data-reactid="5">December 10, 2015</p><p class="post__author" data-reactid="6"><!-- react-text: 7 -->by <!-- /react-text --><a href="/" data-reactid="8">Marc-Andre Giroux</a></p><div data-reactid="9"><p>I recently needed to upload a file from a <a href="https://github.com/facebook/relay">React-Relay</a> App to my <a href="https://github.com/GraphQL">GraphQL</a> Rails server
and found out it was not as straight forward as I thought and not very documented. Thought I’d
share what I have done to make file uploading work with Rails and Relay. Big thanks to
<a href="https://twitter.com/rmosolgo">Robert Mosolgo</a> who guided me towards this solution.</p>
<p>I you haven’t checked out my first blog about <a href="https://github.com/GraphQL">GraphQL</a> you can see it <a href="http://mgiroux.me/2015/getting-started-with-rails-GraphQL-relay/">here</a>.</p>
<h1>Relay</h1>
<p>Relay Mutation have a method called <strong>getFiles</strong> which allows you to send files
to a server. It should return a map of files like this <strong>{[key: string]: File}</strong>
Here’s a quick example of how we could use it:</p>
<pre><code class="language-javascript"><span class="hljs-comment">// A react component to upload a file</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">FileUploader</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">React</span>.<span class="hljs-title">Component</span> </span>{
  onSubmit() {
    <span class="hljs-keyword">const</span> name = <span class="hljs-keyword">this</span>.refs.name.value;
    <span class="hljs-keyword">const</span> file = <span class="hljs-keyword">this</span>.refs.fileInput.files.item(<span class="hljs-number">0</span>);
    Relay.Store.update(
      <span class="hljs-keyword">new</span> UploadFileMutation({
        <span class="hljs-attr">name</span>: name,
        <span class="hljs-attr">file</span>: file,
      })
    );
  }
}

<span class="hljs-comment">// The actual mutation</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">UploadFileMutation</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">Relay</span>.<span class="hljs-title">Mutation</span> </span>{
  getFiles() {
    <span class="hljs-keyword">return</span> {
      <span class="hljs-attr">file</span>: <span class="hljs-keyword">this</span>.props.file,
    };
  }

  <span class="hljs-comment">// ... Rest of your mutation</span>
}
</code></pre>
<h1>GraphQL Rails API</h1>
<p>The part that gets more confusing is how to receive that file server side. If
you’re using GraphQL-js there is this <a href="https://github.com/GraphQL/express-GraphQL/blob/master/src/__tests__/http-test.js#L603">example</a> that explains how you
would design your schema to receive files.</p>
<p>Unfortunatly this wasn’t really possible using <a href="https://github.com/rmosolgo/GraphQL-ruby">GraphQL-ruby</a> and I had
to find another way to do it. Luckily, <a href="https://github.com/rmosolgo/GraphQL-ruby">GraphQL-ruby</a> passes a context argument to
the nodes when it resolves a query. That means we can pass the files along to the query
in the controller and retrieve it at resolve time in the mutation.</p>
<p>Here’s how you could write your controller which in my case is called <strong>QueriesController</strong>.</p>
<pre><code class="language-ruby"><span class="hljs-class"><span class="hljs-keyword">module</span> <span class="hljs-title">V1</span></span>
  <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">QueriesController</span> &lt; ApplicationController</span>

    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">create</span></span>
      query_string = params[<span class="hljs-symbol">:query</span>]
      query_variables = ensure_hash(params[<span class="hljs-symbol">:variables</span>]) <span class="hljs-params">||</span> {}

      query = GraphQL::Query.new(
        YourSchema,
        query_string,
        <span class="hljs-symbol">variables:</span> query_variables,
        <span class="hljs-symbol">context:</span> { <span class="hljs-symbol">file:</span> request.params[<span class="hljs-symbol">:file</span>] }
      )

      render <span class="hljs-symbol">json:</span> query.result
    <span class="hljs-keyword">end</span>

    <span class="hljs-comment"># If the request wasn't `Content-Type: application/json`, parse the variables:</span>
    <span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">ensure_hash</span><span class="hljs-params">(variables_param)</span></span>
      variables_param.kind_of?(Hash) ? variables_param : JSON.parse(variables_param)
    <span class="hljs-keyword">end</span>
  <span class="hljs-keyword">end</span>
<span class="hljs-keyword">end</span>
</code></pre>
<p>You’ll notice that there is an <strong>ensure_hash</strong> method added here. Variables in Relay mutations
with files aren’t sent with a <code>Content-Type: application/json</code> so they arrive as
a String in your controller. Here we simply check if the variables are sent as a Hash and if
they’re not we parse them as JSON.</p>
<p>The rest is pretty straight forward, we add the file param to our context so it can be passed
along during resolve. That means that our Mutation on the server side can look a little bit
like this:</p>
<pre><code class="language-ruby">AddFileMutation = GraphQL::Relay::Mutation.define <span class="hljs-keyword">do</span>
  name <span class="hljs-string">"AddFile"</span>
  input_field <span class="hljs-symbol">:name</span>, !types.String

  <span class="hljs-comment"># ... Add your return_field here</span>

  <span class="hljs-comment"># Here's the mutation operation:</span>
  resolve -&gt; (args, ctx) {
    file = ctx[<span class="hljs-symbol">:file</span>]
    raise StandardError.new(<span class="hljs-string">"Expected a file"</span>) <span class="hljs-keyword">unless</span> file
    <span class="hljs-comment"># ... Do what you want with the file!</span>
  }
<span class="hljs-keyword">end</span>
</code></pre>
<p>Here you have it! Note that <em>you should probably not be uploading large files on
the server</em> and you might want to upload it browser side!</p>
<p>Hope it’ll help some of you!</p>
<p>You can find me on Twitter <a href="https://twitter.com/__xuorig__">@__xuorig__</a> or <a href="http://github.com/xuorig">Github</a></p>
</div><p style="text-align:center;font-weight:bold;margin-top:30px;" data-reactid="10"><!-- react-text: 11 -->Go back to <!-- /react-text --><a href="/" data-reactid="12">Recent Posts</a><!-- react-text: 13 --> ✍️<!-- /react-text --></p><hr data-reactid="14"/><div style="margin-bottom:30px;" data-reactid="15"><h6 data-reactid="16">READ THIS NEXT:</h6><h3 data-reactid="17"><a href="/2016/relays-apply-update-function/" data-reactid="18">Relay&#x27;s new applyUpdate function</a></h3><p data-reactid="19">I recently contributed to Relay and helped implementing a new function on the Relay Store,
applyUpdate. It was recently merged into master and the standard update method was deprecated in v0.6....</p></div><section class="disqus" data-reactid="20"><div id="disqus_thread" data-reactid="21"></div><script type="text/javascript" data-reactid="22"></script></section></div><span style="display:block;clear:both;" data-reactid="23"> </span></div></div><script src="/bundle.js?t=1527958889396"></script><script>
            (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
            m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
            })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

            ga('create', 'UA-69973242-1', 'auto');
            ga('send', 'pageview');
          </script></body></html>